<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="e_design_import.CardCounters">
        <div class="col-md-3">
            <div t-attf-class="card stat-card h-100 border-0 border-top border-{{color ?? 'secondary'}} border-5">
                <div class="card-body text-center">
                    <h2 t-attf-class="text-{{color ?? 'secondary'}} mb-1" t-esc="found"/>
                    <small class="text-muted text-uppercase fw-semibold" t-esc="title ?? 'Unknown'"/>
                    <div class="row">
                        <div class="mt-3 col" t-if="new_count > 0">
                            <span t-attf-class="badge bg-{{color ?? 'secondary'}} rounded-pill px-3 py-2 text-{{color_text ?? 'dark'}}">
                                <i class="bi bi-plus-circle me-1"></i>
                                <t t-esc="new_count"/> New
                            </span>
                        </div>
                        <div class="mt-3 col" t-if="error > 0">
                            <span class="badge bg-danger rounded-pill px-3 py-2 text-light">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                <t t-esc="error"/> Error
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>

    <t t-name="e_design_import.Node">
        <t t-set="nodeError" t-value="isError(node.code)"/>
        <t t-set="nodeDisabled" t-value="isDisabled(node.code)"/>
        <div class="my-1" t-att-class="{'has-error-descendants':nodeError,'has-disabled-descendants':nodeDisabled or nodeError}">
            <div t-attf-class="item-header d-flex align-items-center p-{{padding ?? 3}} mb-2 
                               shadow-sm border-{{color ?? 'secondary'}} {{clickable ? 'cursor-pointer' : ''}}
                               {{nodeError ? 'bg-danger-subtle' : 'bg-' + color + '-subtle'}}"
                 t-on-click="clickable ? () => this.toggleExpand(node.code) : ()=>{}">
                
                <t t-if="node.error and node.error_msg">
                    <span class="me-2 text-danger" t-att-title="node.error_msg">
                        <i class="fa fa-exclamation-triangle"></i>
                    </span>
                </t>
                <div class="form-check me-3" t-on-click.stop="">
                    <input type="checkbox" 
                        class="form-check-input" 
                        t-att-class="{'origin-disabled':nodeDisabled}"
                        t-att-checked="!nodeDisabled"
                        t-att-disabled="nodeError"
                        t-on-change="()=>this.toggleDisabled(node.code)"/>
                </div>
                

                <div class="ms-3 flex-grow-1">
                    <span t-att-class="title_class ?? 'fw-bold fs-6'" t-esc="node.name"/>
                    <span class="badge bg-secondary ms-2" t-esc="node.code"/>
                </div>

                <t t-if="!node.id">
                    <span class="badge bg-secondary rounded-pill me-2">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>New
                    </span>
                </t>
                
                <t t-if="count_badge">
                    <span t-attf-class="badge bg-{{color ?? 'secondary'}} text-{{color_text ?? 'light'}} border rounded-pill">
                        <t t-esc="count_badge"/> items
                    </span>
                </t>
                <t t-if="extra_info_render">
                    <t t-out="extra_info_render"/>
                </t>
            
            </div>
            
            <t t-if="isExpanded(node.code) and children_render">
                <div t-att-class="children_class">
                    <t t-out="children_render"/>
                </div>
            </t>
        </div>
    </t>

    <t t-name="e_design_import.ProductNode">
        <t t-call="e_design_import.Node">
            <t t-set="node" t-value="node"/>
            <t t-set="color" t-value="'warning'"/>
            <t t-set="color_text" t-value="'dark'"/>
            <t t-set="padding" t-value="2"/>
            <t t-set="title_class" t-value="'fw-medium'"/>
            <t t-set="clickable" t-value="!!node.designs?.length"/>
            <t t-set="has_children" t-value="!!node.designs?.length"/>
            <t t-set="icon" t-value="node.id ? 'bi-box-seam-fill' : 'bi-box-seam'"/>
            <t t-set="children_class" t-value="'ms-4 mt-1'"/>
            <t t-set="children_render">
                <t t-if="node.designs?.length">
                    <t t-foreach="node.designs" t-as="design" t-key="design_index">
                        <t t-call="e_design_import.DesignNode">
                            <t t-set="node" t-value="design"/>
                        </t>
                    </t>
                </t>
            </t>
        </t>
    </t>

    <t t-name="e_design_import.DesignNode">
        <t t-call="e_design_import.Node">
            <t t-set="node" t-value="node"/>
            <t t-set="color" t-value="'success'"/>
            <t t-set="color_text" t-value="'light'"/>
            <t t-set="padding" t-value="2"/>
            <t t-set="clickable" t-value="false"/>
            <t t-set="has_children" t-value="false"/>
            <t t-set="count_badge" t-value="false"/>
            <t t-set="children_render" t-value="false"/>
            <t t-set="extra_info_render">
                <span t-if="node.file" class="badge bg-success text-light rounded-pill mx-1">
                    <i class="fa fa-file-o" title="File"/>
                </span>
                <span t-if="node.image" class="badge bg-warning text-dark rounded-pill mx-1">
                    <i class="fa fa-image" title="Image"/>
                </span>
                <span t-if="node.attachments?.length" class="badge bg-info text-light rounded-pill mx-1">
                    <t t-esc="node.attachments.length"/><i class="ms-1 fa fa-folder-o" t-attf-title="{{node.attachments.length}} Attachments"/>
                </span>
            </t>
        </t>
    </t>

    <t t-name="e_design_import.ImportPreview">
        <div class="import-preview-container container-fluid p-4">
            
            <div class="stats-row mb-4">
                <div class="row g-4">
                    <t t-foreach="orderedCounters" t-as="item" t-key="item_index">
                        <t t-call="e_design_import.CardCounters">
                            <t t-set="color" t-value="item.color"/>
                            <t t-set="found" t-value="item.found"/>
                            <t t-set="title" t-value="item.title"/>
                            <t t-set="new_count" t-value="item.new"/>
                            <t t-set="error" t-value="item.error"/>
                            <t t-set="color_text" t-value="item.color_text"/>
                        </t>
                    </t>
                </div>
            </div>

            <div class="tree-container card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-secondary">
                        <i class="bi bi-diagram-3-fill me-2"></i>
                        Structure Preview
                    </span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" t-on-click="expandAll">
                            <i class="bi bi-arrows-expand me-1"></i> Expand All
                        </button>
                        <button class="btn btn-outline-secondary" t-on-click="collapseAll">
                            <i class="bi bi-arrows-collapse me-1"></i> Collapse All
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="category-list">
                        
                        <t t-foreach="previewData.categories" t-as="cat" t-key="cat_index">
                            <t t-call="e_design_import.Node">
                                <t t-set="node" t-value="cat"/>
                                <t t-set="color" t-value="'primary'"/>
                                <t t-set="color_text" t-value="'light'"/>
                                <t t-set="clickable" t-value="true"/>
                                <t t-set="has_children" t-value="true"/>
                                <t t-set="count_badge" t-value="(cat.subcategories?.length || 0) + (cat.designs?.length || 0) + (cat.products?.length || 0)"/>
                                <t t-set="children_class" t-value="'ms-4 ps-2 border-start border-2 border-light'"/>
                                <t t-set="children_render">
                                    <t t-foreach="cat.subcategories" t-as="sub" t-key="sub_index">
                                        <t t-call="e_design_import.Node">
                                            <t t-set="node" t-value="sub"/>
                                            <t t-set="color" t-value="'info'"/>
                                            <t t-set="color_text" t-value="'light'"/>
                                            <t t-set="padding" t-value="2"/>
                                            <t t-set="title_class" t-value="'fw-semibold'"/>
                                            <t t-set="clickable" t-value="true"/>
                                            <t t-set="has_children" t-value="true"/>
                                            <t t-set="count_badge" t-value="(sub.designs?.length || 0) + (sub.products?.length || 0)"/>
                                            <t t-set="children_class" t-value="'ms-4 mt-2'"/>
                                            <t t-set="cat_or_sub_error" t-value="cat.error or sub.error"/>
                                            <t t-set="children_render">
                                                <t t-foreach="sub.products" t-as="prod" t-key="prod_index">
                                                    <t t-call="e_design_import.ProductNode">
                                                        <t t-set="node" t-value="prod"/>
                                                        <t t-set="parent_error" t-value="cat_or_sub_error"/>
                                                    </t>
                                                </t>
                                                
                                                <t t-foreach="sub.designs" t-as="des" t-key="des_index">
                                                    <t t-call="e_design_import.DesignNode">
                                                        <t t-set="node" t-value="des"/>
                                                        <t t-set="parent_error" t-value="cat_or_sub_error"/>
                                                    </t>
                                                </t>
                                            </t>
                                        </t>
                                    </t>
                                    
                                    <t t-foreach="cat.products" t-as="prod" t-key="prod_index">
                                        <t t-call="e_design_import.ProductNode">
                                            <t t-set="node" t-value="prod"/>
                                            <t t-set="parent_error" t-value="cat.error"/>
                                        </t>
                                    </t>
                                    
                                    <t t-foreach="cat.designs" t-as="des" t-key="des_index">
                                        <t t-call="e_design_import.DesignNode">
                                            <t t-set="node" t-value="des"/>
                                            <t t-set="parent_error" t-value="cat.error"/>
                                        </t>
                                    </t>
                                </t>
                            </t>
                        </t>

                        <t t-if="previewData.products?.length">
                            <div class="mt-3 border-top pt-3">
                                <h6 class="text-muted small text-uppercase fw-bold mb-2 ms-3">
                                    <i class="bi bi-box-seam me-1"></i>Standalone Products
                                </h6>
                                <t t-foreach="previewData.products" t-as="node" t-key="node_index">
                                    <t t-call="e_design_import.ProductNode">
                                        <t t-set="node" t-value="node"/>
                                        <t t-set="parent_error" t-value="false"/>
                                    </t>
                                </t>
                            </div>
                        </t>

                        <t t-if="previewData.designs?.length">
                            <div class="mt-3 border-top pt-3">
                                <h6 class="text-muted small text-uppercase fw-bold mb-2 ms-3">
                                    <i class="bi bi-palette me-1"></i>Standalone Designs
                                </h6>
                                <t t-foreach="previewData.designs" t-as="node" t-key="node_index">
                                    <t t-call="e_design_import.DesignNode">
                                        <t t-set="node" t-value="node"/>
                                        <t t-set="parent_error" t-value="false"/>
                                    </t>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>